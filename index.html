<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>PFCバランス計算機（グラフ付き）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"> <!-- Google Fonts -->
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f5f5f5; padding: 16px; font-size: 16px; }
    .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 800px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; margin-bottom: 20px; }
    label { display: block; margin-top: 16px; font-weight: bold; }
    input, select {
      width: 100%; padding: 12px; margin-top: 8px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    input.error { border: 2px solid red; }
    button {
      width: 100%; padding: 14px; margin-top: 20px; font-size: 16px;
      background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    .copy-btn {
      background: #2196F3; margin-top: 10px;
    }
    .result {
      background: #fff; padding: 20px; margin-top: 20px;
      border-radius: 8px; border: 1px solid #ccc;
      font-size: 16px; line-height: 1.6; overflow-x: auto;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc; padding: 10px;
      text-align: center; vertical-align: middle;
      word-break: break-word;
    }
    th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    td {
      background-color: #fafafa;
    }
    #chartContainer {
      margin-top: 30px;
      text-align: center;
    }
    canvas {
      max-width: 400px;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PFCバランス計算機（グラフ付き）</h1>

    <label>総摂取カロリー（kcal）</label>
    <input type="number" id="totalCal" placeholder="例: 2000">

    <label>タンパク質の割合（%）</label>
    <input type="number" id="protein" placeholder="例: 30">

    <label>タンパク質の食事回数</label>
    <select id="proteinMeals">
      <option value="1">1回</option>
      <option value="2">2回</option>
      <option value="3" selected>3回</option>
      <option value="4">4回</option>
      <option value="5">5回</option>
      <option value="6">6回</option>
    </select>

    <label>脂質の割合（%）</label>
    <input type="number" id="fat" placeholder="例: 20">

    <label>脂質の食事回数</label>
    <select id="fatMeals">
      <option value="1">1回</option>
      <option value="2">2回</option>
      <option value="3" selected>3回</option>
      <option value="4">4回</option>
      <option value="5">5回</option>
      <option value="6">6回</option>
    </select>

    <label>炭水化物の割合（%）</label>
    <input type="number" id="carb" placeholder="例: 50">

    <label>炭水化物の食事回数</label>
    <select id="carbMeals">
      <option value="1">1回</option>
      <option value="2">2回</option>
      <option value="3" selected>3回</option>
      <option value="4">4回</option>
      <option value="5">5回</option>
      <option value="6">6回</option>
    </select>

    <button onclick="calculate()">計算する</button>

    <div id="resultContainer" style="display:none;">
      <div class="result" id="result"></div>
      <button class="copy-btn" onclick="copyResult()">結果をコピー</button>
    </div>

    <div id="chartContainer" style="display:none;">
      <h2>バランスグラフ</h2>
      <canvas id="pfcChart"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    let chartInstance = null; // グラフを一度だけ作成

    function saveInputs() {
      const inputs = ["totalCal", "protein", "proteinMeals", "fat", "fatMeals", "carb", "carbMeals"];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        localStorage.setItem(id, el.value);
      });
    }

    function loadInputs() {
      const inputs = ["totalCal", "protein", "proteinMeals", "fat", "fatMeals", "carb", "carbMeals"];
      inputs.forEach(id => {
        const value = localStorage.getItem(id);
        if (value !== null) {
          document.getElementById(id).value = value;
        }
      });
    }

    // 中央テキスト描画のカスタムプラグイン
    const centerTextPlugin = {
      id: 'centerText',
      beforeDraw(chart) {
        const { width, height } = chart;
        const ctx = chart.ctx;
        ctx.restore();

        const fontSizeMain = (height / 140).toFixed(2);
        ctx.font = `700 ${fontSizeMain}em 'Poppins', sans-serif`;
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#333';

        const text = `${totalCal} kcal`;
        const textX = (width - ctx.measureText(text).width) / 2;
        const textY = height / 2 - 10;
        ctx.fillText(text, textX, textY);

        const fontSizeSub = (height / 220).toFixed(2);
        ctx.font = `400 ${fontSizeSub}em 'Poppins', sans-serif`;
        ctx.fillStyle = '#777';
        const subText = 'Total Intake';
        const subTextX = (width - ctx.measureText(subText).width) / 2;
        const subTextY = height / 2 + 20;
        ctx.fillText(subText, subTextX, subTextY);

        ctx.save();
      }
    };

    function calculate() {
      saveInputs();

      const totalCal = parseFloat(document.getElementById("totalCal").value);
      const proteinRatio = parseFloat(document.getElementById("protein").value);
      const fatRatio = parseFloat(document.getElementById("fat").value);
      const carbRatio = parseFloat(document.getElementById("carb").value);

      const proteinMeals = parseInt(document.getElementById("proteinMeals").value);
      const fatMeals = parseInt(document.getElementById("fatMeals").value);
      const carbMeals = parseInt(document.getElementById("carbMeals").value);

      const inputs = ["totalCal", "protein", "fat", "carb"];
      let hasError = false;

      inputs.forEach(id => {
        const el = document.getElementById(id);
        el.classList.remove("error");
        if (!el.value || isNaN(parseFloat(el.value))) {
          el.classList.add("error");
          hasError = true;
        }
      });

      if (hasError) {
        alert("すべての値を正しく入力してください");
        return;
      }

      const totalRatio = proteinRatio + fatRatio + carbRatio;
      if (Math.round(totalRatio) !== 100) {
        ["protein", "fat", "carb"].forEach(id => document.getElementById(id).classList.add("error"));
        alert("P・F・Cの合計が100%になるように入力してください（現在: " + totalRatio.toFixed(1) + "%）");
        return;
      }

      const pCal = totalCal * (proteinRatio / 100);
      const fCal = totalCal * (fatRatio / 100);
      const cCal = totalCal * (carbRatio / 100);

      const pGram = Math.round(pCal / 4);
      const fGram = Math.round(fCal / 9);
      const cGram = Math.round(cCal / 4);

      const pPerMeal = Math.round(pGram / proteinMeals);
      const fPerMeal = Math.round(fGram / fatMeals);
      const cPerMeal = Math.round(cGram / carbMeals);

      document.getElementById("result").innerHTML = `
        <h2>結果（1日あたり）</h2>
        <table>
          <thead>
            <tr><th>栄養素</th><th>合計 (g)</th><th>合計 (kcal)</th><th>食事回数</th><th>1食あたり (g)</th></tr>
          </thead>
          <tbody>
            <tr><td>タンパク質</td><td>${pGram}</td><td>${Math.round(pCal)}</td><td>${proteinMeals}</td><td>${pPerMeal}</td></tr>
            <tr><td>脂質</td><td>${fGram}</td><td>${Math.round(fCal)}</td><td>${fatMeals}</td><td>${fPerMeal}</td></tr>
            <tr><td>炭水化物</td><td>${cGram}</td><td>${Math.round(cCal)}</td><td>${carbMeals}</td><td>${cPerMeal}</td></tr>
          </tbody>
        </table>
      `;
      document.getElementById("resultContainer").style.display = "block";

      // グラフ作成
      if (chartInstance) {
        chartInstance.destroy();
      }
      const ctx = document.getElementById('pfcChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['タンパク質', '脂質', '炭水化物'],
          datasets: [{
            data: [proteinRatio, fatRatio, carbRatio],
            backgroundColor: ['#4CAF50', '#FF9800', '#2196F3'],
            hoverOffset: 30,
            borderWidth: 3,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          cutout: '70%', // 真ん中の空き部分を大きめに
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          }
        },
        plugins: [centerTextPlugin]
      });
      document.getElementById("chartContainer").style.display = "block";
    }

    function copyResult() {
      const resultText = document.getElementById("result").innerText;
      navigator.clipboard.writeText(resultText).then(() => {
        alert("結果をコピーしました！");
      }).catch(err => {
        alert("コピーに失敗しました");
      });
    }

    window.onload = loadInputs;
  </script>
</body>
</html>